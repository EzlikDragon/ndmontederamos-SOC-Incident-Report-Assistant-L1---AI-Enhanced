<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOC Analyst Incident Report Assistant (L1) - AI Enhanced</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0a0a0a;
            --text-color: #00ff41;
            --card-bg: #0a0a0a;
            --border-color: #003b00;
            --primary-color: #00ff41;
            --secondary-color: #008f11;
            --accent-color: #003b00;
        }
        .dark-mode {
            --bg-color: #000000;
            --text-color: #00ff41;
            --card-bg: #0a0a0a;
            --border-color: #008f11;
        }
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: all 0.3s;
            padding: 20px;
            font-family: 'Courier New', monospace;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(0, 255, 65, 0.03) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(0, 143, 17, 0.03) 0%, transparent 20%);
            min-height: 100vh;
            position: relative;
        }
        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.1);
            border-radius: 0;
        }
        .card-header {
            background: linear-gradient(90deg, var(--accent-color), var(--secondary-color));
            border-bottom: 1px solid var(--border-color);
            font-weight: bold;
            letter-spacing: 1px;
        }
        .form-control, .form-select {
            background-color: rgba(0, 0, 0, 0.5);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 0;
            font-family: 'Courier New', monospace;
        }
        .form-control:focus, .form-select:focus {
            background-color: rgba(0, 0, 0, 0.7);
            color: var(--text-color);
            border-color: var(--primary-color);
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.3);
        }
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: #000;
            font-weight: bold;
            border-radius: 0;
        }
        .btn-primary:hover {
            background-color: #00cc34;
            border-color: #00cc34;
            color: #000;
        }
        .btn-outline-secondary {
            color: var(--text-color);
            border-color: var(--border-color);
            border-radius: 0;
        }
        .btn-outline-secondary:hover {
            background-color: var(--border-color);
            color: var(--text-color);
        }
        .log-entry, .action-entry {
            background: rgba(0, 255, 65, 0.05);
            border-left: 4px solid var(--primary-color);
            padding: 10px;
            margin: 5px 0;
            position: relative;
            border-radius: 0;
        }
        .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: transparent;
            border: none;
            color: #ff0033;
            cursor: pointer;
            font-size: 0.8em;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #003b00;
            transition: .4s;
            border-radius: 0;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: #00ff41;
            transition: .4s;
            border-radius: 0;
        }
        input:checked + .toggle-slider {
            background-color: #008f11;
        }
        input:checked + .toggle-slider:before {
            transform: translateX(30px);
        }
        .ai-section {
            background: rgba(0, 143, 17, 0.1);
            border-left: 4px solid var(--secondary-color);
            padding: 15px;
            margin: 15px 0;
            border-radius: 0;
        }
        .resolved-section {
            background: rgba(0, 255, 65, 0.1);
            border-left: 4px solid var(--primary-color);
            padding: 15px;
            margin: 15px 0;
            border-radius: 0;
        }
        textarea {
            min-height: 100px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            border-radius: 0;
        }
        .modal-content {
            background-color: var(--card-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 0;
        }
        .data-point-form {
            background: rgba(0, 255, 65, 0.05);
            padding: 15px;
            border-radius: 0;
            margin: 10px 0;
        }
        .api-key-input {
            font-family: monospace;
            font-size: 0.9em;
        }
        .spinner-border {
            width: 1rem;
            height: 1rem;
            margin-right: 0.5rem;
            border-color: var(--primary-color);
            border-right-color: transparent;
        }
        .status-badge {
            font-size: 0.75em;
            padding: 2px 6px;
            border-radius: 0;
            font-family: 'Courier New', monospace;
        }
        .status-connected {
            background-color: var(--primary-color);
            color: #000;
        }
        .status-disconnected {
            background-color: #333;
            color: var(--text-color);
        }
        .ai-assistant-btn {
            background: linear-gradient(90deg, var(--secondary-color), var(--primary-color));
            border: none;
            color: #000;
            font-weight: bold;
            padding: 12px 24px;
            font-size: 1.1em;
            border-radius: 0;
            letter-spacing: 1px;
        }
        .ai-assistant-btn:hover {
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        }
        .missing-details-alert {
            background: rgba(255, 193, 7, 0.1);
            border-left: 4px solid #ffc107;
            padding: 12px;
            margin: 10px 0;
            border-radius: 0;
        }
        .mitre-badge {
            background-color: var(--secondary-color);
            color: #000;
            padding: 2px 8px;
            border-radius: 0;
            font-size: 0.8em;
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }
        .ioc-badge {
            background-color: #ff0033;
            color: #000;
            padding: 2px 8px;
            border-radius: 0;
            font-size: 0.8em;
            font-weight: bold;
            margin-right: 5px;
            margin-bottom: 5px;
            display: inline-block;
            font-family: 'Courier New', monospace;
        }
        .timeline-item {
            border-left: 3px solid var(--primary-color);
            padding-left: 15px;
            margin-bottom: 10px;
            position: relative;
        }
        .timeline-item:before {
            content: '';
            position: absolute;
            left: -8px;
            top: 0;
            width: 12px;
            height: 12px;
            background: var(--primary-color);
            border-radius: 0;
        }
        /* Matrix rain effect in background */
        .matrix-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            opacity: 0.03;
        }
        /* Footer Styles */
        footer {
            margin-top: 40px;
            padding: 20px 0;
            border-top: 1px solid var(--border-color);
            text-align: center;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: var(--text-color);
            background: rgba(0, 0, 0, 0.7);
        }
        .footer-content {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        .footer-separator {
            color: var(--primary-color);
        }
        .footer-text {
            font-weight: bold;
            letter-spacing: 1px;
        }
        .glitch {
            animation: glitch 2s infinite;
        }
        @keyframes glitch {
            0% { text-shadow: 2px 0 0 #ff0033, -2px 0 0 #00ff41; }
            5% { text-shadow: 2px 0 0 #ff0033, -2px 0 0 #00ff41; }
            6% { text-shadow: -1px 0 0 #ff0033, 1px 0 0 #00ff41; }
            7% { text-shadow: 0 0 0 #ff0033, 0 0 0 #00ff41; }
            8% { text-shadow: -1px 0 0 #ff0033, 1px 0 0 #00ff41; }
            9% { text-shadow: 0 0 0 #ff0033, 0 0 0 #00ff41; }
            10% { text-shadow: 2px 0 0 #ff0033, -2px 0 0 #00ff41; }
            100% { text-shadow: 2px 0 0 #ff0033, -2px 0 0 #00ff41; }
        }
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #000;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--secondary-color);
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-color);
        }
    </style>
</head>
<body>
    <!-- Matrix Background Effect -->
    <div class="matrix-bg" id="matrixBg"></div>
    
    <div class="container-fluid">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 glitch">ü§ñ SOC INCIDENT REPORT ASSISTANT (L1) - AI ENHANCED</h1>
            <div class="d-flex align-items-center gap-3">
                <span>MATRIX MODE</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="darkModeToggle" checked>
                    <span class="toggle-slider"></span>
                </label>
                <button class="btn btn-sm btn-outline-danger" onclick="clearAllData()">CLEAR FORM</button>
            </div>
        </div>

        <!-- Main Form -->
        <div class="row">
            <div class="col-md-8">
                <!-- Basic Info Card -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">INCIDENT REPORT FORM</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">ANALYST NAME</label>
                                <input type="text" class="form-control" id="analystName" value="NICOLE DOMINIQUE MONTEDERAMOS (L1 ANALYST)">
                            </div>
                            
                            <div class="col-md-4">
                                <label class="form-label">ENDPOINT (DETECTION SOURCE)</label>
                                <select class="form-select" id="endpoint">
                                    <option value="">-- SELECT ENDPOINT --</option>
                                    <optgroup label="NETWORK SECURITY">
                                        <option>FIREWALL (PERIMETER)</option>
                                        <option>NGFW (NEXT-GENERATION FIREWALL)</option>
                                        <option>WAF (WEB APPLICATION FIREWALL)</option>
                                        <option>IPS/IDS</option>
                                        <option>VPN GATEWAY</option>
                                        <option>PROXY SERVER</option>
                                        <option>EMAIL GATEWAY / SEG</option>
                                        <option>DNS FILTER</option>
                                    </optgroup>
                                    <optgroup label="HOST & ENDPOINT">
                                        <option>EDR (ENDPOINT DETECTION AND RESPONSE)</option>
                                        <option>AV (ANTIVIRUS)</option>
                                        <option>HIDS</option>
                                        <option>WINDOWS EVENT LOGS</option>
                                        <option>LINUX SYSLOG / AUDITD</option>
                                        <option>MACOS UNIFIED LOGS</option>
                                    </optgroup>
                                    <optgroup label="CLOUD & IDENTITY">
                                        <option>CLOUD SIEM (E.G., SENTINEL)</option>
                                        <option>CSPM (CLOUD SECURITY POSTURE MANAGEMENT)</option>
                                        <option>CASB (CLOUD ACCESS SECURITY BROKER)</option>
                                        <option>IAM AUDIT LOGS</option>
                                        <option>SSO LOGS (OKTA, AZURE AD)</option>
                                    </optgroup>
                                    <optgroup label="APPLICATION & SPECIALIZED">
                                        <option>SAAS AUDIT LOGS (M365, GOOGLE)</option>
                                        <option>DLP (DATA LOSS PREVENTION)</option>
                                        <option>SIEM CORRELATION ALERT</option>
                                        <option>MANUAL REPORT / USER NOTIFICATION</option>
                                    </optgroup>
                                </select>
                            </div>
                            
                            <div class="col-md-4">
                                <label class="form-label">CASE ID (PASTE FROM SIEM)</label>
                                <input type="text" class="form-control" id="caseId" placeholder="E.G., ALERT-2025-1223-8817">
                            </div>
                            
                            <div class="col-md-3">
                                <label class="form-label">STATUS</label>
                                <select class="form-select" id="status" onchange="toggleFormSections()">
                                    <option>UNDER INVESTIGATION</option>
                                    <option>RESOLVED</option>
                                </select>
                            </div>
                            
                            <div class="col-md-3">
                                <label class="form-label">PRIORITY</label>
                                <select class="form-select" id="priority">
                                    <option>INFORMATIONAL</option>
                                    <option>LOW</option>
                                    <option selected>MEDIUM</option>
                                    <option>HIGH</option>
                                    <option>CRITICAL</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">CLASSIFICATION</label>
                                <select class="form-select" id="classification" onchange="updateClassificationReason()">
                                    <option value="">-- SELECT CLASSIFICATION --</option>
                                    <optgroup label="INITIAL ACCESS (TA0001)">
                                        <option>PHISHING (SPEARPHISHING LINK/ATTACHMENT)</option>
                                        <option>MALICIOUS EMAIL (NO INTERACTION CONFIRMED)</option>
                                        <option>EXPLOIT PUBLIC-FACING APPLICATION</option>
                                        <option>EXTERNAL REMOTE SERVICES (RDP/VPN BRUTE FORCE)</option>
                                        <option>VALID ACCOUNTS (CREDENTIAL-BASED ATTACK)</option>
                                        <option>DRIVE-BY COMPROMISE</option>
                                        <option>SUPPLY CHAIN COMPROMISE</option>
                                    </optgroup>
                                    <optgroup label="EXECUTION (TA0002)">
                                        <option>MALWARE EXECUTION</option>
                                        <option>COMMAND AND SCRIPTING INTERPRETER</option>
                                        <option>USER EXECUTION (DOUBLE-CLICKED FILE)</option>
                                        <option>EXPLOITATION FOR CLIENT EXECUTION</option>
                                        <option>SCHEDULED TASK/JOB</option>
                                    </optgroup>
                                    <optgroup label="PERSISTENCE (TA0003)">
                                        <option>ACCOUNT MANIPULATION</option>
                                        <option>BOOT OR LOGON AUTOSTART EXECUTION</option>
                                        <option>SCHEDULED TASK/JOB</option>
                                        <option>VALID ACCOUNTS</option>
                                    </optgroup>
                                    <optgroup label="PRIVILEGE ESCALATION (TA0004)">
                                        <option>EXPLOITATION FOR PRIVILEGE ESCALATION</option>
                                        <option>PROCESS INJECTION</option>
                                        <option>ACCESS TOKEN MANIPULATION</option>
                                    </optgroup>
                                    <optgroup label="DEFENSE EVASION (TA0005)">
                                        <option>OBFUSCATED FILES OR INFORMATION</option>
                                        <option>IMPAIR DEFENSES (AV/EDR TAMPERING)</option>
                                        <option>SIGNED BINARY PROXY EXECUTION</option>
                                        <option>INDICATOR REMOVAL</option>
                                    </optgroup>
                                    <optgroup label="CREDENTIAL ACCESS (TA0006)">
                                        <option>CREDENTIAL DUMPING</option>
                                        <option>BRUTE FORCE</option>
                                        <option>OS CREDENTIAL DUMPING</option>
                                        <option>STEAL OR FORGE KERBEROS TICKETS</option>
                                    </optgroup>
                                    <optgroup label="DISCOVERY (TA0007)">
                                        <option>NETWORK SERVICE DISCOVERY</option>
                                        <option>SYSTEM INFORMATION DISCOVERY</option>
                                        <option>ACCOUNT DISCOVERY</option>
                                        <option>FILE AND DIRECTORY DISCOVERY</option>
                                    </optgroup>
                                    <optgroup label="LATERAL MOVEMENT (TA0008)">
                                        <option>REMOTE SERVICES (SMB, RPC, RDP)</option>
                                        <option>INTERNAL SPEARPHISHING</option>
                                        <option>REPLICATION THROUGH REMOVABLE MEDIA</option>
                                    </optgroup>
                                    <optgroup label="COLLECTION (TA0009)">
                                        <option>DATA FROM LOCAL SYSTEM</option>
                                        <option>EMAIL COLLECTION</option>
                                        <option>SCREEN CAPTURE</option>
                                        <option>AUDIO CAPTURE</option>
                                    </optgroup>
                                    <optgroup label="EXFILTRATION (TA0010)">
                                        <option>EXFILTRATION OVER C2 CHANNEL</option>
                                        <option>AUTOMATED EXFILTRATION</option>
                                        <option>EXFILTRATION OVER WEB SERVICE</option>
                                    </optgroup>
                                    <optgroup label="IMPACT (TA0040)">
                                        <option>DATA ENCRYPTED FOR IMPACT (RANSOMWARE)</option>
                                        <option>SERVICE STOP (DOS)</option>
                                        <option>DEFACEMENT</option>
                                        <option>DATA DESTRUCTION</option>
                                    </optgroup>
                                    <optgroup label="OTHER CATEGORIES">
                                        <option>POLICY VIOLATION</option>
                                        <option>RECONNAISSANCE / SCANNING</option>
                                        <option>SUSPICIOUS NETWORK ACTIVITY</option>
                                        <option>FALSE POSITIVE</option>
                                        <option>TEST / DRILL</option>
                                        <option>DATA SPILLAGE</option>
                                        <option>INSIDER THREAT INDICATOR</option>
                                    </optgroup>
                                </select>
                            </div>
                            
                            <div class="col-12">
                                <label class="form-label">REASON FOR CLASSIFICATION</label>
                                <textarea class="form-control" id="classificationReason" rows="2" placeholder="BRIEF EXPLANATION FOR THE CHOSEN CLASSIFICATION..."></textarea>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">DATE CREATED</label>
                                <input type="datetime-local" class="form-control" id="dateCreated" value="">
                            </div>
                            
                            <div class="col-md-6" id="dateResolvedSection" style="display: none;">
                                <label class="form-label">DATE RESOLVED</label>
                                <input type="datetime-local" class="form-control" id="dateResolved">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- UNDER INVESTIGATION SECTION (Dynamic) -->
                <div id="investigationSection">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">ANALYSIS & CURRENT EVIDENCE</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">CONFIRMED EVIDENCE</label>
                                <div id="confirmedEvidence">
                                    <!-- Dynamic content will appear here -->
                                </div>
                                <button class="btn btn-sm btn-outline-primary mt-2" onclick="showDataPointModal('confirmed')">
                                    + ADD CONFIRMED DATA POINT
                                </button>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">NOT CONFIRMED (GAPS)</label>
                                <div id="notConfirmedEvidence">
                                    <!-- Dynamic content will appear here -->
                                </div>
                                <button class="btn btn-sm btn-outline-primary mt-2" onclick="showDataPointModal('notConfirmed')">
                                    + ADD INVESTIGATION GAP
                                </button>
                            </div>
                            
                            <div class="ai-section">
                                <h6>ANALYSIS NOTES & DETERMINE OUTCOME</h6>
                                <textarea class="form-control" id="determineOutcome" rows="3" placeholder="ANALYSIS NOTES AND DECISION LOGIC..."></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">INVESTIGATION RESPONSE</h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label">TIMELINE & ACTIONS</label>
                                    <textarea class="form-control" id="timelineActions" rows="3" placeholder="CHRONOLOGICAL TIMELINE OF INVESTIGATION ACTIONS..."></textarea>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">CONTAINMENT ACTION</label>
                                    <textarea class="form-control" id="containmentAction" rows="3" placeholder="IMMEDIATE CONTAINMENT STEPS TAKEN..."></textarea>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">ERADICATION & REMEDIATION</label>
                                    <textarea class="form-control" id="eradicationRemediation" rows="3" placeholder="ROOT CAUSE REMOVAL AND REMEDIATION..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">ESCALATION DECISION</h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">DOES THIS NEED L2/L3?</label>
                                    <select class="form-select" id="needsEscalation" onchange="toggleEscalationReason()">
                                        <option>NO</option>
                                        <option>YES</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">REPORT PREPARED BY</label>
                                    <input type="text" class="form-control" id="preparedBy" value="NICOLE DOMINIQUE MONTEDERAMOS (L1 ANALYST)" readonly>
                                </div>
                                <div class="col-12" id="escalationReasonSection" style="display: none;">
                                    <label class="form-label">WHY? (ESCALATION JUSTIFICATION)</label>
                                    <textarea class="form-control" id="escalationReason" rows="2" placeholder="REASON FOR ESCALATING TO L2/L3..."></textarea>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">RECOMMENDATION</label>
                                    <textarea class="form-control" id="recommendation" rows="2" placeholder="RECOMMENDED NEXT STEPS..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RESOLVED SECTION (Dynamic) -->
                <div id="resolvedSection" style="display: none;">
                    <div class="resolved-section">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">RESOLUTION DETAILS</h5>
                            <div class="col-md-4">
                                <label class="form-label">TOTAL TIME TO RESOLVE</label>
                                <input type="text" class="form-control" id="timeToResolve" placeholder="E.G., 1 HOUR 30 MINUTES">
                            </div>
                        </div>
                        
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">WHAT I DID (L1 ACTIONS)</h6>
                            </div>
                            <div class="card-body">
                                <div id="actionsList">
                                    <!-- Dynamic actions will appear here -->
                                </div>
                                <button class="btn btn-sm btn-outline-success mt-2" onclick="showActionModal()">
                                    + ADD ACTION
                                </button>
                            </div>
                        </div>
                        
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">RESPONSE & REMEDIATION ACTIONS</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label">CONTAINMENT</label>
                                        <textarea class="form-control" id="containment" rows="3" placeholder="E.G., BLOCKED MALICIOUS DOMAIN AT FIREWALL..."></textarea>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">ERADICATION</label>
                                        <textarea class="form-control" id="eradication" rows="3" placeholder="E.G., PERFORMED FULL ANTIVIRUS SCAN..."></textarea>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">RECOVERY</label>
                                        <textarea class="form-control" id="recovery" rows="3" placeholder="E.G., RESTORED NORMAL NETWORK ACCESS..."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">WHAT I FOUND (EVIDENCE)</h6>
                            </div>
                            <div class="card-body">
                                <div id="resolvedEvidence">
                                    <!-- Dynamic evidence will appear here -->
                                </div>
                                <button class="btn btn-sm btn-outline-primary mt-2" onclick="showDataPointModal('resolved')">
                                    + ADD EVIDENCE DATA POINT
                                </button>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">FINAL RESULT & CLOSURE</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">IMPACT</label>
                                        <select class="form-select" id="impact">
                                            <option>NONE</option>
                                            <option>MINIMAL</option>
                                            <option>MODERATE</option>
                                            <option>SEVERE</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">DOES THIS NEED L2/L3?</label>
                                        <select class="form-select" id="resolvedEscalation">
                                            <option>NO</option>
                                            <option>YES</option>
                                        </select>
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label">REASON</label>
                                        <textarea class="form-control" id="finalReason" rows="2" placeholder="EXPLANATION OF IMPACT ASSESSMENT..."></textarea>
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label">CLOSURE CHECKLIST</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="check1">
                                            <label class="form-check-label">ALL EVIDENCE COLLECTED AND SAVED</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="check2">
                                            <label class="form-check-label">MALICIOUS INDICATORS (URL/SENDER) BLOCKED</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="check3">
                                            <label class="form-check-label">USER NOTIFIED (IF POLICY REQUIRES)</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="check4" checked>
                                            <label class="form-check-label">NO FURTHER ACTION NEEDED</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="check5">
                                            <label class="form-check-label">TICKET READY TO CLOSE</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">REPORT CLOSED BY</label>
                                        <input type="text" class="form-control" id="closedBy" value="NICOLE DOMINIQUE MONTEDERAMOS (L1 ANALYST)" readonly>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">CLOSED ON</label>
                                        <input type="date" class="form-control" id="closedOn">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Sidebar: AI Tools & Output -->
            <div class="col-md-4">
                <!-- API Configuration Card -->
                <div class="card sticky-top" style="top: 20px;">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">üîß OPENROUTER API</h5>
                        <span id="apiStatusBadge" class="status-badge status-disconnected">DISCONNECTED</span>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">API KEY SOURCE</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="apiKeySource" id="autoApiKey" value="auto" checked onchange="toggleApiKeySource()">
                                <label class="form-check-label" for="autoApiKey">
                                    AUTO-LOAD FROM APIKEY.TXT
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="apiKeySource" id="manualApiKey" value="manual" onchange="toggleApiKeySource()">
                                <label class="form-check-label" for="manualApiKey">
                                    ENTER MANUALLY
                                </label>
                            </div>
                        </div>
                        
                        <div id="manualApiKeySection" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label">API KEY (MANUAL)</label>
                                <input type="password" class="form-control api-key-input" id="apiKeyManual" placeholder="SK-OR-XXXXXXXXXXXXXXXX">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">AI MODEL</label>
                            <select class="form-select" id="aiModel">
                                <option value="openai/gpt-3.5-turbo">GPT-3.5 TURBO (FAST & CHEAP)</option>
                                <option value="openai/gpt-4">GPT-4 (BEST QUALITY)</option>
                                <option value="meta-llama/llama-3.1-8b-instruct">LLAMA 3.1 8B (OPEN SOURCE)</option>
                                <option value="google/gemini-pro">GEMINI PRO (GOOGLE)</option>
                                <option value="anthropic/claude-3-haiku">CLAUDE 3 HAIKU (FAST)</option>
                            </select>
                        </div>
                        <button class="btn btn-outline-success w-100 mb-3" onclick="testAPI()" id="testApiBtn">
                            üß™ TEST API CONNECTION
                        </button>
                        <div id="apiStatus" class="small"></div>
                    </div>
                </div>

                <!-- AI Assistant Card -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="mb-0">ü§ñ AI ASSISTANT</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2 mb-4">
                            <button class="btn ai-assistant-btn" onclick="generateCompleteIncidentReport()" id="aiReportBtn">
                                <span class="spinner-border spinner-border-sm d-none" id="aiReportSpinner"></span>
                                ü§ñ GENERATE COMPLETE INCIDENT REPORT
                            </button>
                            <small class="text-muted text-center">AI WILL ANALYZE FORM DATA, EXTRACT IOCS, MAP MITRE ATT&CK, AND GENERATE PROFESSIONAL SOC REPORT</small>
                        </div>
                        
                        <div id="missingDetailsAlert" class="missing-details-alert" style="display: none;">
                            <strong>‚ö†Ô∏è MISSING CRITICAL DETAILS:</strong>
                            <div id="missingDetailsList"></div>
                        </div>
                        
                        <div id="iocExtraction" style="display: none; margin-top: 10px;">
                            <strong>üïµÔ∏è EXTRACTED IOCS:</strong>
                            <div id="iocList" class="mt-2"></div>
                        </div>
                        
                        <div id="aiOutput" class="mt-3"></div>
                    </div>
                </div>

                <!-- Report Output Card -->
                <div class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">üìÑ FINAL REPORT OUTPUT</h5>
                        <div>
                            <button class="btn btn-sm btn-light me-2" onclick="generateBasicReport()">GENERATE BASIC</button>
                            <button class="btn btn-sm btn-secondary" onclick="copyToClipboard()">üìã COPY</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <textarea class="form-control" id="reportOutput" rows="20" readonly placeholder="COMPLETE AI-GENERATED REPORT WILL APPEAR HERE..."></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-text glitch">NICOLE DOMINIQUE MONTEDERAMOS</div>
                <div class="footer-separator">|</div>
                <div class="footer-text">SOC INCIDENT REPORT ASSISTANT</div>
                <div class="footer-separator">|</div>
                <div class="footer-text">HOMELAB</div>
            </div>
        </div>
    </footer>

    <!-- Data Point Modal -->
    <div class="modal fade" id="dataPointModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ADD DATA POINT</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="dataPointType">
                    <div class="mb-3">
                        <label class="form-label">DATA POINT TYPE</label>
                        <select class="form-select" id="dpType">
                            <option value="">-- SELECT TYPE --</option>
                            <option>NETWORK LOG</option>
                            <option>FIREWALL LOG</option>
                            <option>PROXY LOG</option>
                            <option>EMAIL HEADER</option>
                            <option>EDR ALERT</option>
                            <option>AUTHENTICATION LOG</option>
                            <option>ENDPOINT LOG</option>
                            <option>THREAT INTEL</option>
                            <option>OTHER</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">LOG QUERY / SEARCH</label>
                        <input type="text" class="form-control" id="dpQuery" placeholder="E.G., INDEX=FIREWALL DEST_IP=...">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">DETAIL / RESULT</label>
                        <input type="text" class="form-control" id="dpDetail" placeholder="E.G., CONNECTION BLOCKED, MALWARE HASH: ...">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">SOURCE SYSTEM</label>
                        <input type="text" class="form-control" id="dpSource" placeholder="E.G., SPLUNK, CROWDSTRIKE, FIREWALL-01">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">CANCEL</button>
                    <button type="button" class="btn btn-primary" onclick="addDataPoint()">ADD DATA POINT</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Modal -->
    <div class="modal fade" id="actionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ADD ACTION</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">ACTION TYPE</label>
                        <select class="form-select" id="actionType">
                            <option value="">-- SELECT ACTION --</option>
                            <option>INVESTIGATION & ANALYSIS</option>
                            <option>CONTAINMENT & BLOCKING</option>
                            <option>ERADICATION & REMEDIATION</option>
                            <option>RECOVERY & CLOSURE</option>
                            <option>COMMUNICATION</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">VERB + ACTION</label>
                        <input type="text" class="form-control" id="actionVerb" placeholder="E.G., REVIEWED FIREWALL LOGS, BLOCKED MALICIOUS DOMAIN...">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">TOOL USED</label>
                        <input type="text" class="form-control" id="actionTool" placeholder="E.G., SPLUNK, CROWDSTRIKE CONSOLE, FIREWALL CLI">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">RESULT</label>
                        <input type="text" class="form-control" id="actionResult" placeholder="E.G., CONFIRMED BLOCK, FOUND MALICIOUS FILE...">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">CANCEL</button>
                    <button type="button" class="btn btn-primary" onclick="addAction()">ADD ACTION</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            // Set current date/time
            const now = new Date();
            const localDateTime = now.toISOString().slice(0, 16);
            document.getElementById('dateCreated').value = localDateTime;
            document.getElementById('closedOn').value = now.toISOString().split('T')[0];
            
            // Load saved data
            loadFromLocalStorage();
            
            // Initialize dark mode toggle (Matrix mode by default)
            document.getElementById('darkModeToggle').checked = true;
            document.body.classList.add('dark-mode');
            
            document.getElementById('darkModeToggle').addEventListener('change', function() {
                document.body.classList.toggle('dark-mode', this.checked);
                saveToLocalStorage();
            });
            
            // Auto-save on input
            document.querySelectorAll('input, select, textarea').forEach(element => {
                element.addEventListener('input', saveToLocalStorage);
                element.addEventListener('change', saveToLocalStorage);
            });
            
            // Load AI model preference
            const savedModel = localStorage.getItem('openrouter_model') || 'openai/gpt-3.5-turbo';
            document.getElementById('aiModel').value = savedModel;
            
            // Initialize Matrix background effect
            createMatrixBackground();
        });

        // Matrix background effect
        function createMatrixBackground() {
            const canvas = document.createElement('canvas');
            canvas.id = 'matrixCanvas';
            canvas.style.position = 'fixed';
            canvas.style.top = '0';
            canvas.style.left = '0';
            canvas.style.width = '100%';
            canvas.style.height = '100%';
            canvas.style.pointerEvents = 'none';
            canvas.style.zIndex = '-1';
            canvas.style.opacity = '0.03';
            document.getElementById('matrixBg').appendChild(canvas);
            
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            const letters = "01";
            const fontSize = 14;
            const columns = canvas.width / fontSize;
            const drops = [];
            
            for(let i = 0; i < columns; i++) {
                drops[i] = 1;
            }
            
            function draw() {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.fillStyle = '#00ff41';
                ctx.font = fontSize + 'px monospace';
                
                for(let i = 0; i < drops.length; i++) {
                    const text = letters.charAt(Math.floor(Math.random() * letters.length));
                    ctx.fillText(text, i * fontSize, drops[i] * fontSize);
                    
                    if(drops[i] * fontSize > canvas.height && Math.random() > 0.975) {
                        drops[i] = 0;
                    }
                    drops[i]++;
                }
            }
            
            setInterval(draw, 50);
            
            window.addEventListener('resize', function() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            });
        }

        // ==================== API FUNCTIONS ====================
        
        async function loadApiKeyFromFile() {
            try {
                const response = await fetch('APIkey.txt');
                if (response.ok) {
                    const apiKey = (await response.text()).trim();
                    if (apiKey && apiKey.startsWith('sk-or-')) {
                        document.getElementById('apiKeyManual').value = apiKey;
                        localStorage.setItem('openrouter_api_key', apiKey);
                        updateApiStatus('Auto-loaded from APIkey.txt', 'success');
                        document.getElementById('apiStatusBadge').className = 'status-badge status-connected';
                        document.getElementById('apiStatusBadge').textContent = 'CONNECTED';
                        setTimeout(() => testAPI(), 1000);
                        return true;
                    }
                }
            } catch (error) {
                console.log('APIkey.txt not found or error reading:', error);
            }
            
            const savedApiKey = localStorage.getItem('openrouter_api_key');
            if (savedApiKey) {
                document.getElementById('apiKeyManual').value = savedApiKey;
                updateApiStatus('Using saved API key', 'info');
            } else {
                updateApiStatus('No API key found. Please enter one manually or create APIkey.txt file.', 'warning');
            }
            return false;
        }
        
        function toggleApiKeySource() {
            const autoSelected = document.getElementById('autoApiKey').checked;
            const manualSection = document.getElementById('manualApiKeySection');
            
            if (autoSelected) {
                manualSection.style.display = 'none';
                loadApiKeyFromFile();
            } else {
                manualSection.style.display = 'block';
            }
        }
        
        function updateApiStatus(message, type = 'info') {
            const statusDiv = document.getElementById('apiStatus');
            const alertClass = type === 'success' ? 'alert-success' : 
                             type === 'warning' ? 'alert-warning' : 
                             type === 'danger' ? 'alert-danger' : 'alert-info';
            statusDiv.innerHTML = `
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }

        // Data storage
        let dataPoints = {
            confirmed: [],
            notConfirmed: [],
            resolved: []
        };
        let actions = [];

        // ==================== ENHANCED AI REPORT GENERATION ====================
        
        async function generateCompleteIncidentReport() {
            // Validate basic info first
            const classification = document.getElementById('classification').value;
            const caseId = document.getElementById('caseId').value;
            const endpoint = document.getElementById('endpoint').value;
            
            if (!classification || !caseId || !endpoint) {
                showAIOutput('‚ùå PLEASE FILL IN CLASSIFICATION, CASE ID, AND ENDPOINT FIELDS FIRST.', 'danger');
                return;
            }
            
            showThinking('aiReportBtn', true);
            
            // Collect all form data
            const formData = collectAllFormData();
            
            // Analyze for missing critical details
            const missingDetails = analyzeMissingDetails(formData);
            
            if (missingDetails.length > 0) {
                showMissingDetailsAlert(missingDetails);
            }
            
            // Extract IOCs from evidence
            const iocs = extractIOCs(formData);
            displayExtractedIOCs(iocs);
            
            // Map to MITRE ATT&CK
            const mitreMapping = mapToMitreATTACK(formData.classification);
            
            // Generate AI prompt
            const prompt = createEnhancedAIPrompt(formData, missingDetails, iocs, mitreMapping);
            
            const systemPrompt = `You are an experienced SOC L1 Analyst writing a professional incident report. 
            Write in clear, concise, direct language. No unnecessary symbols or markdown formatting.
            Use standard SOC terminology and structure. Be factual and evidence-based.
            Include MITRE ATT&CK mapping, IOCs, and detailed investigation response.
            If details are missing, note them but still provide a complete report.`;
            
            const result = await callOpenRouterAPI(prompt, systemPrompt, true);
            
            if (result) {
                document.getElementById('reportOutput').value = result;
                showAIOutput('‚úÖ COMPLETE INCIDENT REPORT GENERATED SUCCESSFULLY!', 'success');
                
                // Auto-fill any missing classification reason
                if (!document.getElementById('classificationReason').value.trim()) {
                    extractAndFillClassificationReason(result);
                }
                
                // Auto-fill investigation response fields if empty
                autoFillInvestigationResponse(result);
            }
            
            showThinking('aiReportBtn', false);
        }
        
        // ==================== IOC EXTRACTION ====================
        
        function extractIOCs(formData) {
            const iocs = {
                ips: [],
                domains: [],
                urls: [],
                hashes: [],
                emails: [],
                files: []
            };
            
            // Regex patterns for IOC extraction
            const patterns = {
                ipv4: /\b(?:[0-9]{1,3}\.){3}[0-9]{1,3}\b/g,
                ipv6: /\b(?:[A-F0-9]{1,4}:){7}[A-F0-9]{1,4}\b/gi,
                domain: /\b(?:[a-zA-Z0-9](?:[a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?\.)+[a-zA-Z]{2,}\b/g,
                url: /https?:\/\/[^\s]+/g,
                md5: /\b[a-fA-F0-9]{32}\b/g,
                sha1: /\b[a-fA-F0-9]{40}\b/g,
                sha256: /\b[a-fA-F0-9]{64}\b/g,
                email: /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g,
                filename: /\b\w+\.(exe|dll|bat|ps1|vbs|js|jar|pdf|doc|docx|xls|xlsx|ppt|pptx|lnk)\b/gi
            };
            
            // Extract from all evidence
            const allEvidence = [
                ...formData.confirmedEvidence,
                ...formData.notConfirmedEvidence,
                ...formData.resolvedEvidence
            ];
            
            // Also check form fields for IOCs
            const textFields = [
                formData.determineOutcome,
                formData.escalationReason,
                formData.recommendation,
                formData.containment,
                formData.eradication,
                formData.recovery,
                formData.timelineActions,
                formData.containmentAction,
                formData.eradicationRemediation
            ];
            
            const allText = allEvidence.map(e => e.detail + ' ' + e.query).join(' ') + 
                          ' ' + textFields.join(' ');
            
            // Extract IPs
            const ipv4Matches = allText.match(patterns.ipv4) || [];
            const ipv6Matches = allText.match(patterns.ipv6) || [];
            iocs.ips = [...new Set([...ipv4Matches, ...ipv6Matches])];
            
            // Extract domains
            iocs.domains = [...new Set((allText.match(patterns.domain) || []).filter(d => !d.includes('@')))];
            
            // Extract URLs
            iocs.urls = [...new Set(allText.match(patterns.url) || [])];
            
            // Extract hashes
            iocs.hashes = {
                md5: [...new Set(allText.match(patterns.md5) || [])],
                sha1: [...new Set(allText.match(patterns.sha1) || [])],
                sha256: [...new Set(allText.match(patterns.sha256) || [])]
            };
            
            // Extract emails
            iocs.emails = [...new Set(allText.match(patterns.email) || [])];
            
            // Extract filenames
            iocs.files = [...new Set(allText.match(patterns.filename) || [])];
            
            return iocs;
        }
        
        function displayExtractedIOCs(iocs) {
            const iocDiv = document.getElementById('iocExtraction');
            const iocList = document.getElementById('iocList');
            
            let iocCount = 0;
            let html = '';
            
            // Count total IOCs
            iocCount += iocs.ips.length;
            iocCount += iocs.domains.length;
            iocCount += iocs.urls.length;
            iocCount += iocs.hashes.md5.length + iocs.hashes.sha1.length + iocs.hashes.sha256.length;
            iocCount += iocs.emails.length;
            iocCount += iocs.files.length;
            
            if (iocCount === 0) {
                iocDiv.style.display = 'none';
                return;
            }
            
            // Display IOCs
            if (iocs.ips.length > 0) {
                html += `<div class="mb-2"><strong>IP ADDRESSES:</strong><br>`;
                iocs.ips.forEach(ip => {
                    html += `<span class="ioc-badge">${ip}</span>`;
                });
                html += `</div>`;
            }
            
            if (iocs.domains.length > 0) {
                html += `<div class="mb-2"><strong>DOMAINS:</strong><br>`;
                iocs.domains.forEach(domain => {
                    html += `<span class="ioc-badge">${domain}</span>`;
                });
                html += `</div>`;
            }
            
            if (iocs.urls.length > 0) {
                html += `<div class="mb-2"><strong>URLS:</strong><br>`;
                iocs.urls.forEach(url => {
                    html += `<span class="ioc-badge">${url}</span>`;
                });
                html += `</div>`;
            }
            
            // Hashes
            let allHashes = [...iocs.hashes.md5, ...iocs.hashes.sha1, ...iocs.hashes.sha256];
            if (allHashes.length > 0) {
                html += `<div class="mb-2"><strong>FILE HASHES:</strong><br>`;
                allHashes.forEach(hash => {
                    html += `<span class="ioc-badge">${hash.substring(0, 12)}...</span>`;
                });
                html += `</div>`;
            }
            
            iocList.innerHTML = html;
            iocDiv.style.display = 'block';
        }
        
        // ==================== MITRE ATT&CK MAPPING ====================
        
        function mapToMitreATTACK(classification) {
            const mitreMapping = {
                // Initial Access (TA0001)
                'PHISHING (SPEARPHISHING LINK/ATTACHMENT)': ['T1566', 'PHISHING'],
                'MALICIOUS EMAIL (NO INTERACTION CONFIRMED)': ['T1566', 'PHISHING'],
                'EXPLOIT PUBLIC-FACING APPLICATION': ['T1190', 'EXPLOIT PUBLIC-FACING APPLICATION'],
                'EXTERNAL REMOTE SERVICES (RDP/VPN BRUTE FORCE)': ['T1133', 'EXTERNAL REMOTE SERVICES'],
                'VALID ACCOUNTS (CREDENTIAL-BASED ATTACK)': ['T1078', 'VALID ACCOUNTS'],
                'DRIVE-BY COMPROMISE': ['T1189', 'DRIVE-BY COMPROMISE'],
                'SUPPLY CHAIN COMPROMISE': ['T1195', 'SUPPLY CHAIN COMPROMISE'],
                
                // Execution (TA0002)
                'MALWARE EXECUTION': ['T1204', 'USER EXECUTION'],
                'COMMAND AND SCRIPTING INTERPRETER': ['T1059', 'COMMAND AND SCRIPTING INTERPRETER'],
                'USER EXECUTION (DOUBLE-CLICKED FILE)': ['T1204', 'USER EXECUTION'],
                'EXPLOITATION FOR CLIENT EXECUTION': ['T1203', 'EXPLOITATION FOR CLIENT EXECUTION'],
                'SCHEDULED TASK/JOB': ['T1053', 'SCHEDULED TASK/JOB'],
                
                // Persistence (TA0003)
                'ACCOUNT MANIPULATION': ['T1098', 'ACCOUNT MANIPULATION'],
                'BOOT OR LOGON AUTOSTART EXECUTION': ['T1547', 'BOOT OR LOGON AUTOSTART EXECUTION'],
                'VALID ACCOUNTS': ['T1078', 'VALID ACCOUNTS'],
                
                // Privilege Escalation (TA0004)
                'EXPLOITATION FOR PRIVILEGE ESCALATION': ['T1068', 'EXPLOITATION FOR PRIVILEGE ESCALATION'],
                'PROCESS INJECTION': ['T1055', 'PROCESS INJECTION'],
                'ACCESS TOKEN MANIPULATION': ['T1134', 'ACCESS TOKEN MANIPULATION'],
                
                // Defense Evasion (TA0005)
                'OBFUSCATED FILES OR INFORMATION': ['T1027', 'OBFUSCATED FILES OR INFORMATION'],
                'IMPAIR DEFENSES (AV/EDR TAMPERING)': ['T1562', 'IMPAIR DEFENSES'],
                'SIGNED BINARY PROXY EXECUTION': ['T1218', 'SIGNED BINARY PROXY EXECUTION'],
                'INDICATOR REMOVAL': ['T1070', 'INDICATOR REMOVAL'],
                
                // Credential Access (TA0006)
                'CREDENTIAL DUMPING': ['T1003', 'OS CREDENTIAL DUMPING'],
                'BRUTE FORCE': ['T1110', 'BRUTE FORCE'],
                'OS CREDENTIAL DUMPING': ['T1003', 'OS CREDENTIAL DUMPING'],
                'STEAL OR FORGE KERBEROS TICKETS': ['T1558', 'STEAL OR FORGE KERBEROS TICKETS'],
                
                // Discovery (TA0007)
                'NETWORK SERVICE DISCOVERY': ['T1046', 'NETWORK SERVICE DISCOVERY'],
                'SYSTEM INFORMATION DISCOVERY': ['T1082', 'SYSTEM INFORMATION DISCOVERY'],
                'ACCOUNT DISCOVERY': ['T1087', 'ACCOUNT DISCOVERY'],
                'FILE AND DIRECTORY DISCOVERY': ['T1083', 'FILE AND DIRECTORY DISCOVERY'],
                
                // Lateral Movement (TA0008)
                'REMOTE SERVICES (SMB, RPC, RDP)': ['T1021', 'REMOTE SERVICES'],
                'INTERNAL SPEARPHISHING': ['T1534', 'INTERNAL SPEARPHISHING'],
                'REPLICATION THROUGH REMOVABLE MEDIA': ['T1091', 'REPLICATION THROUGH REMOVABLE MEDIA'],
                
                // Collection (TA0009)
                'DATA FROM LOCAL SYSTEM': ['T1005', 'DATA FROM LOCAL SYSTEM'],
                'EMAIL COLLECTION': ['T1114', 'EMAIL COLLECTION'],
                'SCREEN CAPTURE': ['T1113', 'SCREEN CAPTURE'],
                'AUDIO CAPTURE': ['T1123', 'AUDIO CAPTURE'],
                
                // Exfiltration (TA0010)
                'EXFILTRATION OVER C2 CHANNEL': ['T1041', 'EXFILTRATION OVER C2 CHANNEL'],
                'AUTOMATED EXFILTRATION': ['T1020', 'AUTOMATED EXFILTRATION'],
                'EXFILTRATION OVER WEB SERVICE': ['T1048', 'EXFILTRATION OVER WEB SERVICE'],
                
                // Impact (TA0040)
                'DATA ENCRYPTED FOR IMPACT (RANSOMWARE)': ['T1486', 'DATA ENCRYPTED FOR IMPACT'],
                'SERVICE STOP (DOS)': ['T1489', 'SERVICE STOP'],
                'DEFACEMENT': ['T1491', 'DEFACEMENT'],
                'DATA DESTRUCTION': ['T1485', 'DATA DESTRUCTION'],
                
                // Other Categories
                'POLICY VIOLATION': ['T1078', 'VALID ACCOUNTS'],
                'RECONNAISSANCE / SCANNING': ['T1595', 'ACTIVE SCANNING'],
                'SUSPICIOUS NETWORK ACTIVITY': ['T1046', 'NETWORK SERVICE DISCOVERY'],
                'FALSE POSITIVE': ['N/A', 'NO MITRE MAPPING'],
                'TEST / DRILL': ['N/A', 'NO MITRE MAPPING'],
                'DATA SPILLAGE': ['T1530', 'DATA FROM CLOUD STORAGE'],
                'INSIDER THREAT INDICATOR': ['T1078', 'VALID ACCOUNTS']
            };
            
            return mitreMapping[classification] || ['TBD', 'TO BE DETERMINED'];
        }
        
        // ==================== ENHANCED AI PROMPT ====================
        
        function createEnhancedAIPrompt(formData, missingDetails, iocs, mitreMapping) {
            const status = formData.status;
            const analystName = document.getElementById('analystName').value;
            
            let prompt = `GENERATE A COMPLETE SOC INCIDENT REPORT AS AN L1 ANALYST WOULD WRITE IT FOR THE TEAM.

ANALYST: ${analystName}
CASE ID: ${formData.caseId || 'NOT SPECIFIED'}
DETECTION SOURCE: ${formData.endpoint || 'NOT SPECIFIED'}
STATUS: ${status}
PRIORITY: ${formData.priority}
CLASSIFICATION: ${formData.classification || 'NOT CLASSIFIED'}

MITRE ATT&CK MAPPING:
- TECHNIQUE ID: ${mitreMapping[0]}
- TECHNIQUE NAME: ${mitreMapping[1]}
- TACTIC: ${formData.classification.includes('TA') ? formData.classification.split(' ')[0] : 'TBD'}

TIMELINE:
CREATED: ${formData.dateCreated || 'NOT SPECIFIED'}
${status === 'RESOLVED' ? `RESOLVED: ${formData.dateResolved || 'NOT SPECIFIED'}` : ''}
${formData.timeToResolve ? `TIME TO RESOLVE: ${formData.timeToResolve}` : ''}`;

            // Add IOCs section
            let iocCount = 0;
            iocCount += iocs.ips.length;
            iocCount += iocs.domains.length;
            iocCount += iocs.urls.length;
            iocCount += iocs.hashes.md5.length + iocs.hashes.sha1.length + iocs.hashes.sha256.length;
            iocCount += iocs.emails.length;
            iocCount += iocs.files.length;
            
            if (iocCount > 0) {
                prompt += `\n\nEXTRACTED INDICATORS OF COMPROMISE (IOCS):`;
                
                if (iocs.ips.length > 0) {
                    prompt += `\nIP ADDRESSES: ${iocs.ips.join(', ')}`;
                }
                if (iocs.domains.length > 0) {
                    prompt += `\nDOMAINS: ${iocs.domains.join(', ')}`;
                }
                if (iocs.urls.length > 0) {
                    prompt += `\nURLS: ${iocs.urls.join(', ')}`;
                }
                if (iocs.hashes.md5.length > 0) {
                    prompt += `\nMD5 HASHES: ${iocs.hashes.md5.join(', ')}`;
                }
                if (iocs.hashes.sha1.length > 0) {
                    prompt += `\nSHA1 HASHES: ${iocs.hashes.sha1.join(', ')}`;
                }
                if (iocs.hashes.sha256.length > 0) {
                    prompt += `\nSHA256 HASHES: ${iocs.hashes.sha256.join(', ')}`;
                }
                if (iocs.emails.length > 0) {
                    prompt += `\nEMAIL ADDRESSES: ${iocs.emails.join(', ')}`;
                }
                if (iocs.files.length > 0) {
                    prompt += `\nSUSPICIOUS FILES: ${iocs.files.join(', ')}`;
                }
            }

            // Add evidence section
            prompt += `\n\nEVIDENCE COLLECTED:
CONFIRMED:`;
            if (formData.confirmedEvidence.length > 0) {
                formData.confirmedEvidence.forEach(ev => {
                    prompt += `\n‚Ä¢ ${ev.type}: ${ev.detail} ${ev.source ? `(${ev.source})` : ''}`;
                });
            } else {
                prompt += '\n‚Ä¢ NO CONFIRMED EVIDENCE DOCUMENTED';
            }
            
            prompt += `\n\nNOT CONFIRMED (GAPS):`;
            if (formData.notConfirmedEvidence.length > 0) {
                formData.notConfirmedEvidence.forEach(ev => {
                    prompt += `\n‚Ä¢ ${ev.type}: ${ev.detail}`;
                });
            } else {
                prompt += '\n‚Ä¢ NO INVESTIGATION GAPS DOCUMENTED';
            }
            
            // Add investigation response section
            if (formData.timelineActions || formData.containmentAction || formData.eradicationRemediation) {
                prompt += `\n\nINVESTIGATION RESPONSE:`;
                if (formData.timelineActions) {
                    prompt += `\nTIMELINE & ACTIONS: ${formData.timelineActions}`;
                }
                if (formData.containmentAction) {
                    prompt += `\nCONTAINMENT ACTION: ${formData.containmentAction}`;
                }
                if (formData.eradicationRemediation) {
                    prompt += `\nERADICATION & REMEDIATION: ${formData.eradicationRemediation}`;
                }
            }
            
            // Add analysis section
            if (formData.determineOutcome) {
                prompt += `\n\nANALYSIS NOTES:\n${formData.determineOutcome}`;
            }
            
            // Add actions if resolved
            if (status === 'RESOLVED' && formData.actions.length > 0) {
                prompt += `\n\nACTIONS TAKEN (L1):`;
                formData.actions.forEach(action => {
                    prompt += `\n‚Ä¢ ${action.verb} ${action.result ? `- RESULT: ${action.result}` : ''} ${action.tool ? `(TOOL: ${action.tool})` : ''}`;
                });
            }
            
            // Add resolution details if available
            if (formData.containment || formData.eradication || formData.recovery) {
                prompt += `\n\nRESPONSE ACTIONS:`;
                if (formData.containment) prompt += `\nCONTAINMENT: ${formData.containment}`;
                if (formData.eradication) prompt += `\nERADICATION: ${formData.eradication}`;
                if (formData.recovery) prompt += `\nRECOVERY: ${formData.recovery}`;
            }
            
            // Add escalation info
            if (formData.needsEscalation === 'YES') {
                prompt += `\n\nESCALATION REQUIRED: YES`;
                if (formData.escalationReason) prompt += `\nREASON: ${formData.escalationReason}`;
            }
            
            // Add recommendations
            if (formData.recommendation) {
                prompt += `\n\nRECOMMENDATIONS:\n${formData.recommendation}`;
            }
            
            // Add missing details note
            if (missingDetails.length > 0) {
                prompt += `\n\nNOTE: THE FOLLOWING DETAILS WERE NOT PROVIDED IN THE FORM AND SHOULD BE ACQUIRED FOR A COMPLETE REPORT:`;
                missingDetails.forEach(item => {
                    prompt += `\n‚Ä¢ ${item}`;
                });
            }
            
            prompt += `\n\nGENERATE A PROFESSIONAL SOC INCIDENT REPORT WITH THE FOLLOWING STRUCTURE:
1. EXECUTIVE SUMMARY (BRIEF OVERVIEW OF WHAT HAPPENED, MITRE ATT&CK MAPPING)
2. INCIDENT DETAILS (CASE ID, TIMELINE, CLASSIFICATION, PRIORITY)
3. INDICATORS OF COMPROMISE (IOCS EXTRACTED FROM EVIDENCE)
4. INVESTIGATION RESPONSE (TIMELINE, CONTAINMENT, ERADICATION ACTIONS)
5. EVIDENCE & FINDINGS (WHAT WAS FOUND, CONFIRMED/UNCONFIRMED)
6. ANALYSIS (L1 ASSESSMENT AND DECISION LOGIC, MITRE ATT&CK CONTEXT)
7. ACTIONS TAKEN (WHAT WAS DONE, TOOLS USED, RESULTS)
8. IMPACT ASSESSMENT (BUSINESS/TECHNICAL IMPACT)
9. RECOMMENDATIONS (NEXT STEPS, IMPROVEMENTS, IOC BLOCKING RECOMMENDATIONS)
10. CLOSURE (STATUS, ESCALATION NEEDS, PREPARED BY ${analystName})

WRITE IN CLEAR, CONCISE LANGUAGE WITHOUT UNNECESSARY SYMBOLS OR MARKDOWN. INCLUDE THE ANALYST NAME IN APPROPRIATE SECTIONS.`;
            
            return prompt;
        }
        
        function collectAllFormData() {
            const status = document.getElementById('status').value;
            
            return {
                // Basic Info
                caseId: document.getElementById('caseId').value,
                endpoint: document.getElementById('endpoint').value,
                status: status,
                priority: document.getElementById('priority').value,
                classification: document.getElementById('classification').value,
                classificationReason: document.getElementById('classificationReason').value,
                dateCreated: document.getElementById('dateCreated').value,
                dateResolved: document.getElementById('dateResolved').value,
                
                // Evidence
                confirmedEvidence: dataPoints.confirmed,
                notConfirmedEvidence: dataPoints.notConfirmed,
                resolvedEvidence: dataPoints.resolved,
                
                // Actions
                actions: actions,
                
                // Investigation Response
                timelineActions: document.getElementById('timelineActions').value,
                containmentAction: document.getElementById('containmentAction').value,
                eradicationRemediation: document.getElementById('eradicationRemediation').value,
                
                // Investigation
                determineOutcome: document.getElementById('determineOutcome').value,
                needsEscalation: document.getElementById('needsEscalation').value,
                escalationReason: document.getElementById('escalationReason').value,
                recommendation: document.getElementById('recommendation').value,
                
                // Resolution (if applicable)
                timeToResolve: document.getElementById('timeToResolve').value,
                containment: document.getElementById('containment').value,
                eradication: document.getElementById('eradication').value,
                recovery: document.getElementById('recovery').value,
                impact: document.getElementById('impact').value,
                finalReason: document.getElementById('finalReason').value,
                resolvedEscalation: document.getElementById('resolvedEscalation').value,
                
                // Closure
                preparedBy: document.getElementById('preparedBy').value,
                closedBy: document.getElementById('closedBy').value,
                closedOn: document.getElementById('closedOn').value
            };
        }
        
        function analyzeMissingDetails(formData) {
            const missing = [];
            
            // Critical missing details
            if (!formData.classification) missing.push("CLASSIFICATION (REQUIRED FOR ALL INCIDENTS)");
            if (!formData.caseId) missing.push("CASE ID FROM SIEM (REQUIRED FOR TRACKING)");
            if (!formData.endpoint || formData.endpoint === "-- SELECT ENDPOINT --") missing.push("DETECTION SOURCE/ENDPOINT (REQUIRED FOR CONTEXT)");
            if (!formData.classificationReason) missing.push("REASON FOR CLASSIFICATION (EXPLAINS WHY THIS CLASSIFICATION WAS CHOSEN)");
            
            // Evidence related
            if (formData.confirmedEvidence.length === 0) missing.push("CONFIRMED EVIDENCE DATA POINTS (WHAT YOU ACTUALLY FOUND)");
            
            // Investigation response
            if (!formData.timelineActions) missing.push("TIMELINE & ACTIONS (CHRONOLOGICAL INVESTIGATION STEPS)");
            if (!formData.containmentAction) missing.push("CONTAINMENT ACTION (IMMEDIATE CONTAINMENT STEPS)");
            if (!formData.eradicationRemediation) missing.push("ERADICATION & REMEDIATION (ROOT CAUSE REMOVAL)");
            
            // Status specific
            if (formData.status === 'RESOLVED') {
                if (!formData.containment) missing.push("CONTAINMENT ACTIONS TAKEN");
                if (!formData.eradication) missing.push("ERADICATION STEPS PERFORMED");
                if (!formData.timeToResolve) missing.push("TOTAL TIME TO RESOLVE (FOR METRICS)");
                if (formData.actions.length === 0) missing.push("SPECIFIC ACTIONS TAKEN (WHAT YOU DID)");
            } else {
                if (!formData.determineOutcome) missing.push("DETERMINE OUTCOME LOGIC (DECISION CRITERIA)");
                if (formData.needsEscalation === 'YES' && !formData.escalationReason) missing.push("ESCALATION JUSTIFICATION (WHY L2/L3 NEEDED)");
            }
            
            return missing;
        }
        
        function showMissingDetailsAlert(missingDetails) {
            const alertDiv = document.getElementById('missingDetailsAlert');
            const listDiv = document.getElementById('missingDetailsList');
            
            listDiv.innerHTML = '';
            missingDetails.forEach(item => {
                const div = document.createElement('div');
                div.className = 'small';
                div.textContent = `‚Ä¢ ${item}`;
                listDiv.appendChild(div);
            });
            
            alertDiv.style.display = 'block';
            
            // Auto-hide after 10 seconds
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 10000);
        }
        
        function extractAndFillClassificationReason(aiReport) {
            // Try to extract a summary from the AI report for classification reason
            const lines = aiReport.split('\n');
            let summary = '';
            
            for (let i = 0; i < Math.min(5, lines.length); i++) {
                const line = lines[i].trim();
                if (line && 
                    !line.startsWith('===') && 
                    !line.startsWith('---') && 
                    !line.startsWith('EXECUTIVE') &&
                    !line.startsWith('INCIDENT') &&
                    line.length > 20) {
                    summary = line;
                    break;
                }
            }
            
            if (summary && !document.getElementById('classificationReason').value.trim()) {
                document.getElementById('classificationReason').value = summary;
                saveToLocalStorage();
            }
        }
        
        function autoFillInvestigationResponse(aiReport) {
            // Extract timeline, containment, and eradication from AI report
            const lines = aiReport.split('\n');
            let timeline = '';
            let containment = '';
            let eradication = '';
            let currentSection = '';
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].toLowerCase();
                
                if (line.includes('timeline') || line.includes('chronological')) {
                    currentSection = 'timeline';
                } else if (line.includes('containment')) {
                    currentSection = 'containment';
                } else if (line.includes('eradication') || line.includes('remediation')) {
                    currentSection = 'eradication';
                } else if (line.trim() && currentSection && line.length > 10) {
                    if (currentSection === 'timeline' && !document.getElementById('timelineActions').value) {
                        timeline += lines[i] + ' ';
                    } else if (currentSection === 'containment' && !document.getElementById('containmentAction').value) {
                        containment += lines[i] + ' ';
                    } else if (currentSection === 'eradication' && !document.getElementById('eradicationRemediation').value) {
                        eradication += lines[i] + ' ';
                    }
                }
            }
            
            if (timeline && !document.getElementById('timelineActions').value) {
                document.getElementById('timelineActions').value = timeline.trim();
            }
            if (containment && !document.getElementById('containmentAction').value) {
                document.getElementById('containmentAction').value = containment.trim();
            }
            if (eradication && !document.getElementById('eradicationRemediation').value) {
                document.getElementById('eradicationRemediation').value = eradication.trim();
            }
            
            saveToLocalStorage();
        }
        
        // ==================== API CALL FUNCTION ====================
        
        async function callOpenRouterAPI(prompt, systemPrompt = null, autoReplace = false) {
            const apiKeySource = document.querySelector('input[name="apiKeySource"]:checked').value;
            let apiKey;
            
            if (apiKeySource === 'auto') {
                apiKey = localStorage.getItem('openrouter_api_key');
                if (!apiKey) {
                    const loaded = await loadApiKeyFromFile();
                    if (!loaded) {
                        showAIOutput('‚ùå NO API KEY FOUND. PLEASE CHECK APIKEY.TXT FILE OR ENTER MANUALLY.', 'danger');
                        return null;
                    }
                    apiKey = localStorage.getItem('openrouter_api_key');
                }
            } else {
                apiKey = document.getElementById('apiKeyManual').value.trim();
                if (!apiKey) {
                    showAIOutput('‚ùå PLEASE ENTER YOUR OPENROUTER API KEY.', 'danger');
                    return null;
                }
                localStorage.setItem('openrouter_api_key', apiKey);
            }
            
            const model = document.getElementById('aiModel').value;
            localStorage.setItem('openrouter_model', model);
            
            const messages = [];
            
            if (systemPrompt) {
                messages.push({
                    role: "system",
                    content: systemPrompt
                });
            }
            
            messages.push({
                role: "user",
                content: prompt
            });
            
            try {
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`,
                        'HTTP-Referer': window.location.origin,
                        'X-Title': 'SOC REPORT ASSISTANT'
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: messages,
                        max_tokens: 2500,
                        temperature: 0.3
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API ERROR: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                return data.choices[0].message.content;
                
            } catch (error) {
                console.error('OPENROUTER API ERROR:', error);
                showAIOutput(`‚ùå API ERROR: ${error.message}`, 'danger');
                return null;
            }
        }
        
        function showAIOutput(message, type = 'success') {
            const outputDiv = document.getElementById('aiOutput');
            const alertClass = type === 'danger' ? 'alert-danger' : 
                             type === 'warning' ? 'alert-warning' : 'alert-success';
            outputDiv.innerHTML = `
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }
        
        function showThinking(buttonId, show) {
            const button = document.getElementById(buttonId);
            const spinner = document.getElementById(buttonId.replace('Btn', 'Spinner'));
            
            if (show) {
                button.disabled = true;
                spinner.classList.remove('d-none');
            } else {
                button.disabled = false;
                spinner.classList.add('d-none');
            }
        }
        
        // Test API connection
        async function testAPI() {
            showThinking('testApiBtn', true);
            
            const prompt = "PLEASE RESPOND WITH 'API CONNECTION SUCCESSFUL' IF YOU CAN READ THIS MESSAGE.";
            const systemPrompt = "YOU ARE A TEST ASSISTANT. RESPOND ONLY WITH THE CONFIRMATION MESSAGE.";
            
            const result = await callOpenRouterAPI(prompt, systemPrompt);
            
            showThinking('testApiBtn', false);
            
            if (result && result.includes('successful')) {
                updateApiStatus('‚úÖ API CONNECTION SUCCESSFUL! YOU CAN NOW USE AI FEATURES.', 'success');
                document.getElementById('apiStatusBadge').className = 'status-badge status-connected';
                document.getElementById('apiStatusBadge').textContent = 'CONNECTED';
            } else if (result) {
                updateApiStatus('‚ö†Ô∏è API RESPONDED BUT WITH UNEXPECTED MESSAGE: ' + result, 'warning');
            }
        }
        
        // ==================== EXISTING FUNCTIONS ====================
        
        // Modal functions
        function showDataPointModal(type) {
            document.getElementById('dataPointType').value = type;
            document.getElementById('dpType').value = '';
            document.getElementById('dpQuery').value = '';
            document.getElementById('dpDetail').value = '';
            document.getElementById('dpSource').value = '';
            new bootstrap.Modal(document.getElementById('dataPointModal')).show();
        }

        function showActionModal() {
            document.getElementById('actionType').value = '';
            document.getElementById('actionVerb').value = '';
            document.getElementById('actionTool').value = '';
            document.getElementById('actionResult').value = '';
            new bootstrap.Modal(document.getElementById('actionModal')).show();
        }

        function addDataPoint() {
            const type = document.getElementById('dataPointType').value;
            const dpType = document.getElementById('dpType').value;
            const query = document.getElementById('dpQuery').value;
            const detail = document.getElementById('dpDetail').value;
            const source = document.getElementById('dpSource').value;
            
            if (!dpType || !detail) {
                alert('PLEASE FILL IN AT LEAST TYPE AND DETAIL FIELDS');
                return;
            }
            
            const dataPoint = {
                id: Date.now(),
                type: dpType,
                query: query,
                detail: detail,
                source: source
            };
            
            dataPoints[type].push(dataPoint);
            renderDataPoints(type);
            saveToLocalStorage();
            
            bootstrap.Modal.getInstance(document.getElementById('dataPointModal')).hide();
        }

        function addAction() {
            const actionType = document.getElementById('actionType').value;
            const verb = document.getElementById('actionVerb').value;
            const tool = document.getElementById('actionTool').value;
            const result = document.getElementById('actionResult').value;
            
            if (!verb) {
                alert('PLEASE ENTER AN ACTION');
                return;
            }
            
            const action = {
                id: Date.now(),
                type: actionType,
                verb: verb,
                tool: tool,
                result: result
            };
            
            actions.push(action);
            renderActions();
            saveToLocalStorage();
            
            bootstrap.Modal.getInstance(document.getElementById('actionModal')).hide();
        }

        function deleteDataPoint(type, id) {
            dataPoints[type] = dataPoints[type].filter(dp => dp.id !== id);
            renderDataPoints(type);
            saveToLocalStorage();
        }

        function deleteAction(id) {
            actions = actions.filter(action => action.id !== id);
            renderActions();
            saveToLocalStorage();
        }

        function renderDataPoints(type) {
            const containerId = type + 'Evidence';
            const container = document.getElementById(containerId);
            
            if (!container) return;
            
            container.innerHTML = '';
            
            dataPoints[type].forEach(dp => {
                const div = document.createElement('div');
                div.className = 'log-entry';
                div.innerHTML = `
                    <strong>${dp.type}</strong>: ${dp.detail}
                    ${dp.query ? `<br><small>QUERY: ${dp.query}</small>` : ''}
                    ${dp.source ? `<br><small>SOURCE: ${dp.source}</small>` : ''}
                    <button class="delete-btn" onclick="deleteDataPoint('${type}', ${dp.id})">‚úï</button>
                `;
                container.appendChild(div);
            });
        }

        function renderActions() {
            const container = document.getElementById('actionsList');
            if (!container) return;
            
            container.innerHTML = '';
            
            actions.forEach(action => {
                const div = document.createElement('div');
                div.className = 'action-entry';
                div.innerHTML = `
                    <strong>${action.type || 'ACTION'}</strong>: ${action.verb}
                    ${action.tool ? `<br><small>TOOL: ${action.tool}</small>` : ''}
                    ${action.result ? `<br><small>RESULT: ${action.result}</small>` : ''}
                    <button class="delete-btn" onclick="deleteAction(${action.id})">‚úï</button>
                `;
                container.appendChild(div);
            });
        }

        // Form toggle functions
        function toggleFormSections() {
            const status = document.getElementById('status').value;
            const investigationSection = document.getElementById('investigationSection');
            const resolvedSection = document.getElementById('resolvedSection');
            const dateResolvedSection = document.getElementById('dateResolvedSection');
            
            if (status === 'RESOLVED') {
                investigationSection.style.display = 'none';
                resolvedSection.style.display = 'block';
                dateResolvedSection.style.display = 'block';
                
                if (!document.getElementById('dateResolved').value) {
                    const now = new Date();
                    document.getElementById('dateResolved').value = now.toISOString().slice(0, 16);
                }
            } else {
                investigationSection.style.display = 'block';
                resolvedSection.style.display = 'none';
                dateResolvedSection.style.display = 'none';
            }
            saveToLocalStorage();
        }

        function toggleEscalationReason() {
            const needsEscalation = document.getElementById('needsEscalation').value;
            const section = document.getElementById('escalationReasonSection');
            section.style.display = needsEscalation === 'YES' ? 'block' : 'none';
        }

        function updateClassificationReason() {
            const classification = document.getElementById('classification').value;
            const reasonField = document.getElementById('classificationReason');
            
            const reasonSuggestions = {
                'PHISHING (SPEARPHISHING LINK/ATTACHMENT)': 'MALICIOUS EMAIL DELIVERED WITH EMBEDDED LINK/ATTACHMENT. USER INTERACTION UNKNOWN.',
                'MALICIOUS EMAIL (NO INTERACTION CONFIRMED)': 'SUSPICIOUS EMAIL REACHED INBOX. NO EVIDENCE OF USER INTERACTION.',
                'MALWARE EXECUTION': 'MALICIOUS CODE EXECUTED ON ENDPOINT. CONTAINMENT REQUIRED.',
                'SUSPICIOUS NETWORK ACTIVITY': 'ANOMALOUS NETWORK TRAFFIC DETECTED. FURTHER INVESTIGATION NEEDED.',
                'POLICY VIOLATION': 'USER/SYSTEM VIOLATED SECURITY POLICY. REQUIRES REVIEW.',
                'FALSE POSITIVE': 'ALERT TRIGGERED INCORRECTLY. NO ACTUAL THREAT.',
                'VALID ACCOUNTS (CREDENTIAL-BASED ATTACK)': 'UNAUTHORIZED ACCESS USING VALID CREDENTIALS. CREDENTIAL RESET REQUIRED.'
            };
            
            if (reasonSuggestions[classification] && !reasonField.value) {
                reasonField.value = reasonSuggestions[classification];
            }
        }

        // Basic Report Generation (non-AI)
        function generateBasicReport() {
            const status = document.getElementById('status').value;
            let report = '';
            
            if (status === 'UNDER INVESTIGATION') {
                report = generateInvestigationReport();
            } else {
                report = generateResolvedReport();
            }
            
            document.getElementById('reportOutput').value = report;
            saveToLocalStorage();
        }

        function generateInvestigationReport() {
            const analystName = document.getElementById('analystName').value;
            
            return `INCIDENT REPORT - FOR ESCALATION
ANALYST: ${analystName}
CASE ID: ${document.getElementById('caseId').value || 'N/A'}
STATUS: UNDER INVESTIGATION
PRIORITY: ${document.getElementById('priority').value}
CLASSIFICATION: ${document.getElementById('classification').value}
REASON FOR CLASSIFICATION: ${document.getElementById('classificationReason').value}
DATE CREATED: ${document.getElementById('dateCreated').value}
ENDPOINT: ${document.getElementById('endpoint').value}

ANALYSIS & CURRENT EVIDENCE
CONFIRMED:
${dataPoints.confirmed.map(dp => `- ${dp.type}: ${dp.detail} ${dp.source ? `(SOURCE: ${dp.source})` : ''}`).join('\n')}

NOT CONFIRMED:
${dataPoints.notConfirmed.map(dp => `- ${dp.type}: ${dp.detail}`).join('\n')}

INVESTIGATION RESPONSE
TIMELINE & ACTIONS: ${document.getElementById('timelineActions').value}
CONTAINMENT ACTION: ${document.getElementById('containmentAction').value}
ERADICATION & REMEDIATION: ${document.getElementById('eradicationRemediation').value}

DETERMINE OUTCOME:
${document.getElementById('determineOutcome').value}

ESCALATION DECISION:
NEEDS L2/L3: ${document.getElementById('needsEscalation').value}
${document.getElementById('needsEscalation').value === 'YES' ? `REASON: ${document.getElementById('escalationReason').value}\n` : ''}
RECOMMENDATION: ${document.getElementById('recommendation').value}

REPORT PREPARED BY: ${analystName}
INCIDENT LEAD: TBD`;
        }

        function generateResolvedReport() {
            const analystName = document.getElementById('analystName').value;
            const checks = [
                document.getElementById('check1').checked ? '‚úì' : '‚úó',
                document.getElementById('check2').checked ? '‚úì' : '‚úó',
                document.getElementById('check3').checked ? '‚úì' : '‚úó',
                document.getElementById('check4').checked ? '‚úì' : '‚úó',
                document.getElementById('check5').checked ? '‚úì' : '‚úó'
            ];
            
            return `INCIDENT REPORT - RESOLVED
ANALYST: ${analystName}
CASE ID: ${document.getElementById('caseId').value || 'N/A'}
STATUS: RESOLVED
PRIORITY: ${document.getElementById('priority').value}
FINAL CLASSIFICATION: ${document.getElementById('classification').value}
DATE CREATED: ${document.getElementById('dateCreated').value}
DATE RESOLVED: ${document.getElementById('dateResolved').value}
TOTAL TIME TO RESOLVE: ${document.getElementById('timeToResolve').value}
ENDPOINT: ${document.getElementById('endpoint').value}

WHAT I DID (L1 ACTIONS):
${actions.map(action => `- ${action.verb} ${action.result ? `(${action.result})` : ''}`).join('\n')}

INVESTIGATION RESPONSE
TIMELINE & ACTIONS: ${document.getElementById('timelineActions').value}
CONTAINMENT ACTION: ${document.getElementById('containmentAction').value}
ERADICATION & REMEDIATION: ${document.getElementById('eradicationRemediation').value}

RESPONSE & REMEDIATION ACTIONS:
CONTAINMENT: ${document.getElementById('containment').value}
ERADICATION: ${document.getElementById('eradication').value}
RECOVERY: ${document.getElementById('recovery').value}

WHAT I FOUND (EVIDENCE):
${dataPoints.resolved.map(dp => `- ${dp.type}: ${dp.detail} ${dp.source ? `(SOURCE: ${dp.source})` : ''}`).join('\n')}

FINAL RESULT:
IMPACT: ${document.getElementById('impact').value}
REASON: ${document.getElementById('finalReason').value}
NEEDS L2/L3: ${document.getElementById('resolvedEscalation').value}

CLOSURE CHECKLIST:
${checks[0]} ALL EVIDENCE COLLECTED AND SAVED
${checks[1]} MALICIOUS INDICATORS (URL/SENDER) BLOCKED
${checks[2]} USER NOTIFIED (IF POLICY REQUIRES)
${checks[3]} NO FURTHER ACTION NEEDED
${checks[4]} TICKET READY TO CLOSE

REPORT CLOSED BY: ${analystName}
CLOSED ON: ${document.getElementById('closedOn').value}`;
        }

        function copyToClipboard() {
            const textarea = document.getElementById('reportOutput');
            textarea.select();
            textarea.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(textarea.value).then(() => {
                alert('REPORT COPIED TO CLIPBOARD!');
            });
        }

        // Local Storage
        function saveToLocalStorage() {
            const data = {
                analystName: document.getElementById('analystName').value,
                endpoint: document.getElementById('endpoint').value,
                caseId: document.getElementById('caseId').value,
                status: document.getElementById('status').value,
                priority: document.getElementById('priority').value,
                classification: document.getElementById('classification').value,
                classificationReason: document.getElementById('classificationReason').value,
                dateCreated: document.getElementById('dateCreated').value,
                dateResolved: document.getElementById('dateResolved').value,
                timelineActions: document.getElementById('timelineActions').value,
                containmentAction: document.getElementById('containmentAction').value,
                eradicationRemediation: document.getElementById('eradicationRemediation').value,
                determineOutcome: document.getElementById('determineOutcome').value,
                needsEscalation: document.getElementById('needsEscalation').value,
                escalationReason: document.getElementById('escalationReason').value,
                recommendation: document.getElementById('recommendation').value,
                timeToResolve: document.getElementById('timeToResolve').value,
                containment: document.getElementById('containment').value,
                eradication: document.getElementById('eradication').value,
                recovery: document.getElementById('recovery').value,
                impact: document.getElementById('impact').value,
                finalReason: document.getElementById('finalReason').value,
                resolvedEscalation: document.getElementById('resolvedEscalation').value,
                closedOn: document.getElementById('closedOn').value,
                darkMode: document.getElementById('darkModeToggle').checked,
                dataPoints: dataPoints,
                actions: actions
            };
            localStorage.setItem('socReportData', JSON.stringify(data));
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('socReportData');
            if (saved) {
                const data = JSON.parse(saved);
                
                document.getElementById('analystName').value = data.analystName || 'NICOLE DOMINIQUE MONTEDERAMOS (L1 ANALYST)';
                document.getElementById('endpoint').value = data.endpoint || '';
                document.getElementById('caseId').value = data.caseId || '';
                document.getElementById('status').value = data.status || 'UNDER INVESTIGATION';
                document.getElementById('priority').value = data.priority || 'MEDIUM';
                document.getElementById('classification').value = data.classification || '';
                document.getElementById('classificationReason').value = data.classificationReason || '';
                document.getElementById('dateCreated').value = data.dateCreated || '';
                document.getElementById('dateResolved').value = data.dateResolved || '';
                document.getElementById('timelineActions').value = data.timelineActions || '';
                document.getElementById('containmentAction').value = data.containmentAction || '';
                document.getElementById('eradicationRemediation').value = data.eradicationRemediation || '';
                document.getElementById('determineOutcome').value = data.determineOutcome || '';
                document.getElementById('needsEscalation').value = data.needsEscalation || 'NO';
                document.getElementById('escalationReason').value = data.escalationReason || '';
                document.getElementById('recommendation').value = data.recommendation || '';
                document.getElementById('timeToResolve').value = data.timeToResolve || '';
                document.getElementById('containment').value = data.containment || '';
                document.getElementById('eradication').value = data.eradication || '';
                document.getElementById('recovery').value = data.recovery || '';
                document.getElementById('impact').value = data.impact || 'NONE';
                document.getElementById('finalReason').value = data.finalReason || '';
                document.getElementById('resolvedEscalation').value = data.resolvedEscalation || 'NO';
                document.getElementById('closedOn').value = data.closedOn || '';
                document.getElementById('darkModeToggle').checked = data.darkMode || false;
                
                document.body.classList.toggle('dark-mode', data.darkMode);
                
                if (data.dataPoints) {
                    dataPoints = data.dataPoints;
                    renderDataPoints('confirmed');
                    renderDataPoints('notConfirmed');
                    renderDataPoints('resolved');
                }
                
                if (data.actions) {
                    actions = data.actions;
                    renderActions();
                }
                
                toggleFormSections();
                toggleEscalationReason();
            }
        }

        function clearAllData() {
            if (confirm('CLEAR ALL FORM DATA? THIS CANNOT BE UNDONE.')) {
                localStorage.removeItem('socReportData');
                location.reload();
            }
        }
    </script>
</body>
</html>
